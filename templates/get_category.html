{% extends 'layout.html' %}

{% block title %}Categoría{% endblock %}

{% block body %}
  <div class="container mt-5 mb-5">
    <div class="row mb-5">
      <h2 class="text-center">{{ category.category }}</h2>
      <p>{{ category.desc }}</p>
      <div>
        <!-- Botón para marcar como favorita -->
        <button class="btn btn-primary" id="favorite-btn" data-category-id="{{ category.id }}">
          {% if is_favorite %}
          <i class="fas fa-times"></i> Quitar de Favoritos
          {% else %}
          <i class="fas fa-star"></i> Marcar como Favorito
          {% endif %}
        </button>
      </div>
    </div>
    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for blog in category.blogs.all %}
        {% if blog.is_active and blog.is_published %}
          {% include "card.html" with blog=blog %}
        {% endif %}
      {% empty %}
        <p class="text-center">No se encontraron blogs!</p>
      {% endfor %}
    </div>
  </div>

<!-- Modal para confirmar agregar o quitar de favoritos -->
<div class="modal fade" id="favoriteModal" tabindex="-1" aria-labelledby="favoriteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="favoriteModalLabel">Confirmar Acción</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="favoriteModalMessage"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
        <button type="button" class="btn btn-primary" id="confirm-favorite-btn">Aceptar</button>
      </div>
    </div>
  </div>
</div>



  {% if category.subcategory_type == "paga" %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Definir el HTML del modal con un id único
        const modalHtml = `
          <div class="modal fade" id="paymentModalUnique" tabindex="-1" aria-labelledby="paymentModalLabelUnique" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="paymentModalLabelUnique">¡Esta es una categoría de paga!</h5>
                </div>
                <div class="modal-body">
                  <p>Para tener acceso a esta categoría, debe pagar una membresía única de Gs: {{ costo_membresia }}</p>
                  <p>Costo de la membresia Gs: {{ costo_membresia }}</p>
                  <button id="buyMembershipButtonUnique" class="btn btn-primary">Comprar membresía</button>
                  <button id="continueButtonUnique" class="btn btn-secondary">Continuar</button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Mostrar el modal con opciones para deshabilitar el cierre automático
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModalUnique'), {
          backdrop: 'static',
          keyboard: false
        });
        paymentModal.show();

        // Manejar el clic en el botón "Comprar membresía"
        const buyMembershipButton = document.getElementById('buyMembershipButtonUnique');
        buyMembershipButton.addEventListener('click', function() {
          // Crear y enviar el formulario de pago
          const form = document.createElement('form');
          form.action = 'https://checkout.wompi.co/p/';
          form.method = 'GET';

          const publicKey = document.createElement('input');
          publicKey.type = 'hidden';
          publicKey.name = 'public-key';
          publicKey.value = 'pub_test_501zz4iE1TnIknS0Ob5DEs22JFFVaxYe';
          form.appendChild(publicKey);

          const currency = document.createElement('input');
          currency.type = 'hidden';
          currency.name = 'currency';
          currency.value = 'COP';
          form.appendChild(currency);

          const amount = document.createElement('input');
          amount.type = 'hidden';
          amount.name = 'amount-in-cents';
          amount.value = '{{ costo_membresia|floatformat:0 }}';  // '1000';
          form.appendChild(amount);

          const reference = document.createElement('input');
          reference.type = 'hidden';
          reference.name = 'reference';
          reference.value = 'referencia_pago_web_checkout_ejemplo_01';
          form.appendChild(reference);

          document.body.appendChild(form);
          form.submit();
        });

        // Manejar el clic en el botón "Continuar"
        const continueButton = document.getElementById('continueButtonUnique');
        continueButton.addEventListener('click', function() {
          // Cerrar el modal
          const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModalUnique'));
          paymentModal.hide();
        });
      });
    </script>
  {% endif %}


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const favoriteBtn = document.getElementById('favorite-btn');
      const favoriteModal = new bootstrap.Modal(document.getElementById('favoriteModal'));
      const confirmFavoriteBtn = document.getElementById('confirm-favorite-btn');
      const favoriteModalMessage = document.getElementById('favoriteModalMessage');
  
      favoriteBtn.addEventListener('click', function() {
        if (favoriteBtn.textContent.trim() === 'Marcar como Favorito') {
          favoriteModalMessage.textContent = '¿Quieres agregar esta categoría como favorita?';
        } else {
          favoriteModalMessage.textContent = '¿Quieres quitar esta categoría de tus favoritas?';
        }
        favoriteModal.show();
      });

      confirmFavoriteBtn.addEventListener('click', function() {
        const categoryId = favoriteBtn.getAttribute('data-category-id');
        fetch(`/blogs/toggle_favorite_category/${categoryId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'added') {
            favoriteBtn.textContent = 'Quitar de Favoritos';
          } else {
            favoriteBtn.textContent = 'Marcar como Favorito';
          }
          favoriteModal.hide();
        });
      });
    });
    </script>


{% endblock %}